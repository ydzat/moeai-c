# MoeAI-C 总体设计文档

## 文档目的

本文档旨在详细说明MoeAI-C项目的模块职责划分与各组件之间的相互关系，完成design.md中的里程碑2和3的要求：
- 为每个模块明确目标功能
- 明确每个`.c`文件的函数接口和结构体数据
- 确定参数传递方式
- 确定跨模块引用头文件路径设计

## 文档结构

本文档将按以下结构组织内容：
1. 总体架构概览
2. 各模块职责分配
3. 组件间通信与交互
4. 详细接口设计

更详细的各组件实现请参考对应的子文档：
- [核心模块设计](./core_design.md)
- [功能模块设计](./modules_design.md)
- [通信机制设计](./communication_design.md)
- [工具与辅助组件设计](./utils_design.md)
- [数据处理设计](./data_design.md)

## 1. 总体架构概览

MoeAI-C项目采用模块化设计，分为以下几个主要部分：

```
            +--------------------+
            |      用户层        |
            | (CLI / 应用程序)    |
            +----------^---------+
                       |
            +----------v---------+
            |     用户态代理      |
            | (agent / daemon)   |
            +----------^---------+
                       |
+----------------------------------------------+
|           内核态 MoeAI-C 模块                |
|  +--------+    +--------+    +---------+    |
|  | 核心层  |<-->| 功能层  |<-->| 通信层  |    |
|  +--------+    +--------+    +---------+    |
|  |        |    |        |    |         |    |
|  | 模块管理|    | 内存监控|    | Procfs  |    |
|  | 事件调度|    | 网络防护|    | Netlink |    |
|  | 状态管理|    | 文件系统|    |         |    |
|  +--------+    +--------+    +---------+    |
|                     ^                       |
|                     |                       |
|            +--------v---------+             |
|            |   工具与数据层    |             |
|            |  日志/环形缓冲区  |             |
|            |  统计/快照/历史   |             |
|            +------------------+             |
+----------------------------------------------+
```

## 2. 各模块职责分配

### 2.1 核心模块 (`src/core/`)

- **init.c**: 模块初始化序列控制
- **module_loader.c**: 子功能模块的动态管理
- **scheduler.c**: 事件调度与处理框架
- **event_loop.c**: 事件循环与定时任务管理

### 2.2 功能模块 (`src/modules/`)

- **mem_monitor.c**: 内存状态监控与管理
- **net_guard.c**: 网络活动监控与防护
- **fs_logger.c**: 文件系统活动监控与日志

### 2.3 通信模块 (`src/ipc/`)

- **procfs.c**: procfs文件系统接口实现
- **netlink.c**: Netlink通信协议实现

### 2.4 工具模块 (`src/utils/`)

- **logger.c**: 统一日志系统实现
- **ring_buffer.c**: 环形缓冲区数据结构

### 2.5 数据模块 (`src/data/`)

- **stats.c**: 实时统计数据收集
- **snapshot.c**: 系统状态快照管理
- **history.c**: 历史数据记录与分析

### 2.6 用户态组件

- **CLI工具** (`cli/`): 命令行接口工具
- **智能代理** (`agent/`): 用户态AI助手实现

## 3. 组件间通信与交互

### 3.1 内部通信方式

- **核心模块间**: 函数调用 + 共享数据结构
- **核心与功能模块**: 通过模块接口注册回调
- **功能与数据模块**: 函数调用
- **通信与其他模块**: 回调注册 + 事件通知

### 3.2 外部通信方式

- **内核与CLI工具**: procfs接口
- **内核与智能代理**: procfs + 未来扩展Netlink

### 3.3 数据传递方案

- **数据封装**: 结构体定义在头文件中，各模块引用
- **事件传递**: 统一事件结构，包含类型、优先级和数据指针
- **命令传递**: 字符串命令+参数，由解析器统一处理
- **状态共享**: 通过中央状态管理器

## 4. 详细接口设计

具体每个模块的详细接口设计，请参照相应的子设计文档。以下是通用接口设计原则（遵循Linux内核编码风格）：

### 4.1 函数命名规范

- 使用小写字母，单词之间用下划线分隔
- 模块前缀: `moeai_<模块名>_`
- 操作动词常用: `init`, `exit`, `start`, `stop`, `handle`, `get`, `set`
- 函数名应具有描述性，避免缩写（除非是公认的缩写）
- 例如: `moeai_mem_monitor_init()`, `moeai_logger_write()`

### 4.2 结构体命名规范

- 结构体名称使用小写字母，单词之间用下划线分隔
- 模块前缀: `moeai_<模块名>_`
- 不使用匈牙利命名法或类型后缀（如`_t`）
- 结构体标签与类型名相同（Linux内核风格）
- 例如:
```c
struct moeai_event {
    /* 成员 */
};
```

### 4.3 头文件包含规则

- 头文件包含顺序:
  1. 当前文件对应的头文件（如有）
  2. 内核头文件 (<linux/...>)
  3. 标准库头文件
  4. 其他模块的头文件
- 项目头文件使用相对路径 (`#include "utils/logger.h"`)
- 每组头文件之间应有一个空行分隔

### 4.4 错误处理策略

- 函数返回值: 成功返回0，失败返回负错误码（使用标准的Linux内核错误码如-EINVAL, -ENOMEM等）
- 指针函数: 成功返回有效指针，失败返回NULL或ERR_PTR
- 使用`IS_ERR`和`PTR_ERR`宏处理错误指针
- 错误应记录到日志系统
- 应清理已分配的资源，避免内存泄漏
- 错误路径应被清晰标记（使用goto语句处理清理代码）

### 4.5 代码格式规范

- 使用制表符（tab）进行缩进，宽度为8个字符
- 一行代码不应超过80个字符
- 花括号的放置：
  - 开始花括号与控制语句同行
  - 结束花括号单独一行
  - 单语句的if/for/while可以省略花括号
- 多个赋值语句应垂直对齐
- 注释风格：
  - 使用`/*...*/`进行多行注释
  - 使用`//`进行单行注释